<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Scanner Pro - Trading Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0B0E11',
                            card: '#161A1E',
                            hover: '#1E2329',
                            border: '#2B3139',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', sans-serif;
        }
        .glow-green {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }
        .glow-red {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body class="bg-dark-bg text-gray-100">
    <!-- Header -->
    <header class="bg-dark-card border-b border-dark-border sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="text-2xl">üìä</div>
                    <div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                            Crypto Scanner Pro
                        </h1>
                        <p class="text-xs text-gray-500">Professional Trading Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="bot-status" class="flex items-center space-x-2 px-3 py-1.5 bg-dark-hover rounded-lg">
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse"></div>
                        <span class="text-sm text-gray-400">Loading...</span>
                    </div>
                    <div class="text-xs text-gray-500" id="version">v2.2.3</div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- EMA Scanner Status -->
            <div class="bg-dark-card border border-dark-border rounded-lg p-4 hover:border-blue-500 transition-all">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-blue-400">üéØ EMA Scanner</div>
                    <div id="ema-status" class="w-2 h-2 bg-gray-500 rounded-full"></div>
                </div>
                <div class="text-2xl font-bold" id="ema-count">-</div>
                <div class="text-xs text-gray-500 mt-1">Active Signals</div>
            </div>

            <!-- Flip Scanner Status -->
            <div class="bg-dark-card border border-dark-border rounded-lg p-4 hover:border-purple-500 transition-all">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-purple-400">üîÑ Flip Scanner</div>
                    <div id="flip-status" class="w-2 h-2 bg-gray-500 rounded-full"></div>
                </div>
                <div class="text-2xl font-bold" id="flip-count">-</div>
                <div class="text-xs text-gray-500 mt-1">Flip Opportunities</div>
            </div>

            <!-- Volume Scanner Status -->
            <div class="bg-dark-card border border-dark-border rounded-lg p-4 hover:border-emerald-500 transition-all">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-emerald-400">üìä Volume Scanner</div>
                    <div id="volume-status" class="w-2 h-2 bg-gray-500 rounded-full"></div>
                </div>
                <div class="text-2xl font-bold" id="volume-count">-</div>
                <div class="text-xs text-gray-500 mt-1">High Volume</div>
            </div>

            <!-- ATH/ATL Scanner Status -->
            <div class="bg-dark-card border border-dark-border rounded-lg p-4 hover:border-amber-500 transition-all">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-amber-400">üèÜ ATH/ATL Scanner</div>
                    <div id="ath-status" class="w-2 h-2 bg-gray-500 rounded-full"></div>
                </div>
                <div class="text-2xl font-bold" id="ath-count">40</div>
                <div class="text-xs text-gray-500 mt-1">Coins Monitored</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Market Overview -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Top Gainers/Losers Tabs -->
                <div class="bg-dark-card border border-dark-border rounded-lg overflow-hidden">
                    <div class="flex border-b border-dark-border">
                        <button onclick="switchMarketTab('gainers')" id="tab-gainers" class="flex-1 px-4 py-3 text-sm font-medium bg-dark-hover text-emerald-400 border-b-2 border-emerald-400">
                            üöÄ Top Gainers
                        </button>
                        <button onclick="switchMarketTab('losers')" id="tab-losers" class="flex-1 px-4 py-3 text-sm font-medium text-gray-400 hover:text-gray-300">
                            üìâ Top Losers
                        </button>
                        <button onclick="switchMarketTab('monitored')" id="tab-monitored" class="flex-1 px-4 py-3 text-sm font-medium text-gray-400 hover:text-gray-300">
                            üëÅÔ∏è Monitored (40)
                        </button>
                    </div>

                    <!-- Gainers Table -->
                    <div id="content-gainers" class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-dark-hover text-xs text-gray-500 uppercase">
                                <tr>
                                    <th class="px-4 py-3 text-left">#</th>
                                    <th class="px-4 py-3 text-left">Coin</th>
                                    <th class="px-4 py-3 text-right">Price</th>
                                    <th class="px-4 py-3 text-right">24h Change</th>
                                    <th class="px-4 py-3 text-right">Volume</th>
                                </tr>
                            </thead>
                            <tbody id="gainers-tbody" class="text-sm">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">Loading market data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Losers Table -->
                    <div id="content-losers" class="overflow-x-auto hidden">
                        <table class="w-full">
                            <thead class="bg-dark-hover text-xs text-gray-500 uppercase">
                                <tr>
                                    <th class="px-4 py-3 text-left">#</th>
                                    <th class="px-4 py-3 text-left">Coin</th>
                                    <th class="px-4 py-3 text-right">Price</th>
                                    <th class="px-4 py-3 text-right">24h Change</th>
                                    <th class="px-4 py-3 text-right">Volume</th>
                                </tr>
                            </thead>
                            <tbody id="losers-tbody" class="text-sm">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">Loading market data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Monitored Table -->
                    <div id="content-monitored" class="overflow-x-auto hidden">
                        <table class="w-full">
                            <thead class="bg-dark-hover text-xs text-gray-500 uppercase">
                                <tr>
                                    <th class="px-4 py-3 text-left">#</th>
                                    <th class="px-4 py-3 text-left">Coin</th>
                                    <th class="px-4 py-3 text-right">Price</th>
                                    <th class="px-4 py-3 text-right">24h Change</th>
                                    <th class="px-4 py-3 text-right">Volume</th>
                                </tr>
                            </thead>
                            <tbody id="monitored-tbody" class="text-sm">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">Loading market data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column: Alerts & Scanner Status -->
            <div class="space-y-6">
                <!-- Recent Alerts -->
                <div class="bg-dark-card border border-dark-border rounded-lg overflow-hidden">
                    <div class="px-4 py-3 bg-dark-hover border-b border-dark-border flex items-center justify-between">
                        <h3 class="text-sm font-medium">üîî Recent Alerts</h3>
                        <span class="text-xs text-gray-500">Live</span>
                    </div>
                    <div id="alerts-container" class="p-4 space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center py-8 text-gray-500 text-sm">
                            Waiting for alerts...
                        </div>
                    </div>
                </div>

                <!-- Scanner Configuration Quick Access -->
                <div class="bg-dark-card border border-dark-border rounded-lg overflow-hidden">
                    <div class="px-4 py-3 bg-dark-hover border-b border-dark-border">
                        <h3 class="text-sm font-medium">‚öôÔ∏è Scanner Settings</h3>
                    </div>
                    <div class="p-4 space-y-4">
                        <!-- EMA Touch -->
                        <div class="flex items-center justify-between py-2 border-b border-dark-border">
                            <div>
                                <div class="text-sm font-medium">EMA Touch</div>
                                <div class="text-xs text-gray-500">Threshold: <span id="ema-threshold">2.0</span>%</div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="ema-toggle" class="sr-only peer" checked onchange="toggleScanner('ema_touch')">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>

                        <!-- Daily Flip -->
                        <div class="flex items-center justify-between py-2 border-b border-dark-border">
                            <div>
                                <div class="text-sm font-medium">Daily Flip</div>
                                <div class="text-xs text-gray-500">Threshold: <span id="flip-threshold">2.0</span>%</div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="flip-toggle" class="sr-only peer" checked onchange="toggleScanner('daily_flip')">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>

                        <!-- Volume Scanner -->
                        <div class="flex items-center justify-between py-2 border-b border-dark-border">
                            <div>
                                <div class="text-sm font-medium">Volume Scanner</div>
                                <div class="text-xs text-gray-500">Gainers: <span id="gainers-threshold">10</span>%</div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="volume-toggle" class="sr-only peer" checked onchange="toggleScanner('volume_scanner')">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                            </label>
                        </div>

                        <!-- ATH/ATL Scanner -->
                        <div class="flex items-center justify-between py-2">
                            <div>
                                <div class="text-sm font-medium">ATH/ATL Scanner</div>
                                <div class="text-xs text-gray-500">Proximity: <span id="ath-threshold">1.0</span>%</div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="ath-toggle" class="sr-only peer" checked onchange="toggleScanner('ath_atl')">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Telegram Status -->
                <div id="telegram-warning" class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 hidden">
                    <div class="flex items-start space-x-3">
                        <div class="text-2xl">‚ö†Ô∏è</div>
                        <div>
                            <div class="font-medium text-amber-400 text-sm mb-1">Telegram Not Configured</div>
                            <div class="text-xs text-amber-200/70">Configure in Settings ‚Üí Add-ons ‚Üí Crypto Scanner Pro</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '.';
        let currentConfig = {};

        // Initialize
        async function init() {
            await loadConfig();
            await loadMarketData();
            checkTelegramStatus();

            // Auto refresh every 30 seconds
            setInterval(loadMarketData, 30000);
        }

        // Load configuration
        async function loadConfig() {
            try {
                const res = await fetch(`${API_URL}/scanner-api/config`);
                currentConfig = await res.json();

                // Update threshold displays
                if (currentConfig.ema_touch) {
                    document.getElementById('ema-threshold').textContent = currentConfig.ema_touch.ema_touch_threshold || 2.0;
                    document.getElementById('ema-toggle').checked = currentConfig.ema_touch.enabled;
                }
                if (currentConfig.daily_flip) {
                    document.getElementById('flip-threshold').textContent = currentConfig.daily_flip.flip_threshold || 2.0;
                    document.getElementById('flip-toggle').checked = currentConfig.daily_flip.enabled;
                }
                if (currentConfig.volume_scanner) {
                    document.getElementById('gainers-threshold').textContent = currentConfig.volume_scanner.gainers_threshold || 10;
                    document.getElementById('volume-toggle').checked = currentConfig.volume_scanner.enabled;
                }
                if (currentConfig.ath_atl) {
                    document.getElementById('ath-threshold').textContent = currentConfig.ath_atl.proximity_threshold || 1.0;
                    document.getElementById('ath-toggle').checked = currentConfig.ath_atl.enabled;
                }

                updateBotStatus();
            } catch (e) {
                console.error('Error loading config:', e);
            }
        }

        // Update bot status indicators
        function updateBotStatus() {
            const scanners = {
                'ema-status': currentConfig.ema_touch?.enabled,
                'flip-status': currentConfig.daily_flip?.enabled,
                'volume-status': currentConfig.volume_scanner?.enabled,
                'ath-status': currentConfig.ath_atl?.enabled
            };

            Object.entries(scanners).forEach(([id, enabled]) => {
                const el = document.getElementById(id);
                if (el) {
                    el.className = `w-2 h-2 rounded-full ${enabled ? 'bg-emerald-400 animate-pulse' : 'bg-gray-600'}`;
                }
            });

            // Update main bot status
            const allEnabled = Object.values(scanners).some(v => v);
            const statusEl = document.getElementById('bot-status');
            if (allEnabled) {
                statusEl.innerHTML = `
                    <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
                    <span class="text-sm text-emerald-400 font-medium">Online</span>
                `;
            } else {
                statusEl.innerHTML = `
                    <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
                    <span class="text-sm text-gray-500">Offline</span>
                `;
            }
        }

        // Toggle scanner
        async function toggleScanner(scannerName) {
            const newConfig = { ...currentConfig };
            const toggle = document.getElementById(`${scannerName.split('_')[0]}-toggle`);

            if (newConfig[scannerName]) {
                newConfig[scannerName].enabled = toggle.checked;

                try {
                    const res = await fetch(`${API_URL}/scanner-api/config`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newConfig)
                    });

                    if (res.ok) {
                        currentConfig = newConfig;
                        updateBotStatus();
                    }
                } catch (e) {
                    console.error('Error toggling scanner:', e);
                    toggle.checked = !toggle.checked; // Revert
                }
            }
        }

        // Load market data
        async function loadMarketData() {
            try {
                const res = await fetch(`${API_URL}/scanner-api/ath-atl/status`);
                const data = await res.json();

                if (data.success) {
                    renderTable('gainers-tbody', data.top_gainers || []);
                    renderTable('losers-tbody', data.top_losers || []);
                    renderTable('monitored-tbody', data.monitored_coins || []);
                }
            } catch (e) {
                console.error('Error loading market data:', e);
            }
        }

        // Render table
        function renderTable(tbodyId, coins) {
            const tbody = document.getElementById(tbodyId);

            if (!coins || coins.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No data available</td></tr>';
                return;
            }

            tbody.innerHTML = coins.map((coin, index) => {
                const isPositive = coin.change_24h >= 0;
                const changeColor = isPositive ? 'text-emerald-400' : 'text-red-400';
                const bgColor = isPositive ? 'bg-emerald-400/5' : 'bg-red-400/5';

                return `
                    <tr class="border-b border-dark-border hover:bg-dark-hover transition-colors">
                        <td class="px-4 py-3 text-gray-500">${index + 1}</td>
                        <td class="px-4 py-3 font-medium">${coin.symbol.replace('USDT', '')}</td>
                        <td class="px-4 py-3 text-right text-gray-300">$${formatPrice(coin.price)}</td>
                        <td class="px-4 py-3 text-right">
                            <span class="${changeColor} ${bgColor} px-2 py-1 rounded text-sm font-medium">
                                ${isPositive ? '+' : ''}${coin.change_24h.toFixed(2)}%
                            </span>
                        </td>
                        <td class="px-4 py-3 text-right text-gray-400 text-sm">$${formatVolume(coin.volume_24h)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Switch market tab
        function switchMarketTab(tab) {
            const tabs = ['gainers', 'losers', 'monitored'];
            tabs.forEach(t => {
                document.getElementById(`tab-${t}`).className = `flex-1 px-4 py-3 text-sm font-medium text-gray-400 hover:text-gray-300`;
                document.getElementById(`content-${t}`).classList.add('hidden');
            });

            const color = tab === 'gainers' ? 'emerald' : tab === 'losers' ? 'red' : 'blue';
            document.getElementById(`tab-${tab}`).className = `flex-1 px-4 py-3 text-sm font-medium bg-dark-hover text-${color}-400 border-b-2 border-${color}-400`;
            document.getElementById(`content-${tab}`).classList.remove('hidden');
        }

        // Check Telegram status
        async function checkTelegramStatus() {
            try {
                const res = await fetch(`${API_URL}/scanner-api/health`);
                const health = await res.json();

                const warning = document.getElementById('telegram-warning');
                if (!health.telegram_configured) {
                    warning.classList.remove('hidden');
                } else {
                    warning.classList.add('hidden');
                }
            } catch (e) {
                console.error('Error checking Telegram:', e);
            }
        }

        // Format price
        function formatPrice(price) {
            if (price >= 1) return price.toFixed(2);
            if (price >= 0.01) return price.toFixed(4);
            return price.toFixed(6);
        }

        // Format volume
        function formatVolume(volume) {
            if (volume >= 1e9) return (volume / 1e9).toFixed(2) + 'B';
            if (volume >= 1e6) return (volume / 1e6).toFixed(2) + 'M';
            return volume.toFixed(0);
        }

        // Start
        init();
    </script>
</body>
</html>
